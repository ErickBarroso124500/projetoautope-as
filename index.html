<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Arthur Auto Pe√ßas - Encontre pe√ßas automotivas de alta qualidade.">
    <title>Arthur Auto Pe√ßas | Premium</title>
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@300;600&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0052cc;
            --secondary-color: #4b5e77;
            --accent-color: #00cc00;
            --background-color: #f4f7fa;
            --text-color: #2d3748;
            --card-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* Navbar */
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1rem 0;
            sticky: top;
        }

        .navbar-brand {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .nav-link {
            font-weight: 500;
            transition: 0.3s;
            margin: 0 8px;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        /* Hero */
        .hero {
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .carousel-item img {
            height: 400px;
            object-fit: cover;
            filter: brightness(0.6);
        }

        .carousel-caption h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Products container */
        .search-bar {
            max-width: 600px;
            margin: -25px auto 30px;
            position: relative;
            z-index: 10;
            padding: 0 15px;
        }

        .search-input {
            border-radius: 50px;
            padding: 15px 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: none;
            width: 100%;
        }

        .category-btn {
            background: white;
            color: var(--secondary-color);
            border: 1px solid #ddd;
            padding: 8px 20px;
            border-radius: 20px;
            margin: 5px;
            transition: 0.3s;
        }

        .category-btn:hover,
        .category-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .product-card {
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: var(--card-shadow);
            transition: 0.3s;
            overflow: hidden;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .product-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Admin Badge */
        .admin-badge {
            background: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Points Badge */
        .points-display {
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Floating Cart */
        .cart-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--accent-color);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0, 200, 0, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: 0.3s;
        }

        .cart-float:hover {
            transform: scale(1.1);
        }

        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>

    <!-- DATA & CONFIG -->
    <script>
        const AppConfig = {
            supabaseUrl: 'https://ydwxljgmzoqsemwemtml.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkd3hsamdtem9xc2Vtd2VtdG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODM4ODEsImV4cCI6MjA4MDY1OTg4MX0.7elSMr11AHIhYayJgwqJQCpv0CdyiiM5XunW82Y-rAo',
            geminiKey: 'AIzaSyCO22vM99hmTcsUB6RwEqgDXcsO-UrO1VQ', // User provided key
            whatsapp: '5585991815434'
        };

        const State = {
            user: JSON.parse(localStorage.getItem('user')) || null,
            cart: JSON.parse(localStorage.getItem('cart')) || [],
            products: [],
            orders: [] // For admin
        };
    </script>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="public/logo.png" style="height: 40px; margin-right: 10px;"
                    onerror="this.style.display='none'">
                Arthur Auto Pe√ßas
            </a>

            <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navcol"><span
                    class="navbar-toggler-icon"></span></button>

            <div class="collapse navbar-collapse" id="navcol">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="#produtos">Produtos</a></li>

                    <!-- Guest View -->
                    <li class="nav-item" id="nav-guest">
                        <button class="btn btn-outline-primary rounded-pill btn-sm px-4"
                            onclick="UI.modal('login-modal')">Entrar / Cadastrar</button>
                    </li>

                    <!-- Logged View -->
                    <li class="nav-item dropdown" id="nav-user" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <span class="points-display me-2"><i class="fas fa-star text-warning"></i> <span
                                    id="user-points">0</span></span>
                            <span id="user-name" class="fw-bold">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                            <li id="gift-badge" style="display:none;"><a class="dropdown-item text-success fw-bold"
                                    href="#"><i class="fas fa-gift"></i> Resgatar Brinde!</a></li>
                            <li id="admin-link" style="display:none;"><a class="dropdown-item" href="#"
                                    onclick="Admin.openPanel()">Painel Admin</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="Auth.logout()">Sair</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <section class="hero carousel slide" data-bs-ride="carousel" id="heroCar">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=1920&q=80"
                    class="d-block w-100">
                <div class="carousel-caption">
                    <h1 class="display-4">Arthur Auto Pe√ßas</h1>
                    <p class="lead">Qualidade e Fidelidade. Acumule pontos a cada compra!</p>
                </div>
            </div>
            <div class="carousel-item">
                <img src="https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=1920&q=80"
                    class="d-block w-100">
                <div class="carousel-caption">
                    <h1>Programa de Fidelidade</h1>
                    <p class="lead">Ganhe brindes exclusivos acumulando 1600 pontos.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- SEARCH & FILTER -->
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Buscar pe√ßa..." oninput="Products.filter(this.value)">
    </div>

    <div class="container text-center mb-5">
        <button class="category-btn active" onclick="Products.filterCat('all', this)">Todos</button>
        <button class="category-btn" onclick="Products.filterCat('pneus', this)">Pneus</button>
        <button class="category-btn" onclick="Products.filterCat('motor', this)">Motor</button>
        <button class="category-btn" onclick="Products.filterCat('freios', this)">Freios</button>
        <button class="category-btn" onclick="Products.filterCat('eletrica', this)">El√©trica</button>
    </div>

    <!-- PRODUCTS GRID -->
    <section id="produtos" class="container mb-5">
        <h3 class="text-center mb-4 fw-bold text-secondary">Nossos Produtos</h3>
        <div class="row g-4" id="products-grid">
            <!-- Rendered by JS -->
        </div>
    </section>

    <!-- ADMIN PANEL (Hidden) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="admin-panel">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title">Administra√ß√£o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="nav nav-tabs mb-3" id="adminTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-orders">Pedidos
                        Pendentes</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-stock">Estoque</a></li>
            </ul>
            <div class="tab-content">
                <!-- Orders Tab -->
                <div class="tab-pane fade show active" id="tab-orders">
                    <p class="small text-muted">Aprove pedidos finalizados no WhatsApp para dar pontos aos clientes.</p>
                    <div id="admin-orders-list" class="list-group"></div>
                </div>
                <!-- Stock Tab -->
                <div class="tab-pane fade" id="tab-stock">
                    <button class="btn btn-success w-100 mb-3" onclick="UI.modal('add-prod-modal')"><i
                            class="fas fa-plus"></i> Novo Produto</button>
                    <div id="admin-products-list" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART ICON -->
    <div class="cart-float" onclick="UI.modal('cart-modal')">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-count" id="cart-count">0</div>
    </div>

    <!-- MODALS -->

    <!-- Login Modal -->
    <div class="modal fade" id="login-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h4 class="fw-bold">Login</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form onsubmit="Auth.login(event)">
                    <div class="mb-3"><label>Email</label><input type="email" id="log-email" class="form-control"
                            required></div>
                    <div class="mb-3"><label>Senha</label><input type="password" id="log-pass" class="form-control"
                            required></div>
                    <button class="btn btn-primary w-100 mb-2">Entrar</button>
                </form>
                <div class="text-center mt-3">
                    <a href="#" class="small text-decoration-none"
                        onclick="UI.switchModal('login-modal', 'recover-modal')">Esqueci a senha</a> |
                    <a href="#" class="small fw-bold text-decoration-none"
                        onclick="UI.switchModal('login-modal', 'register-modal')">N√£o tem conta? Cadastre-se!</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="register-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <h4 class="fw-bold mb-3">Criar Conta</h4>
                <form onsubmit="Auth.register(event)">
                    <div class="mb-2"><label>Nome Completo</label><input type="text" id="reg-nome" class="form-control"
                            required></div>
                    <div class="mb-2"><label>Email</label><input type="email" id="reg-email" class="form-control"
                            required></div>
                    <div class="mb-2"><label>CPF</label><input type="text" id="reg-cpf" class="form-control" required>
                    </div>
                    <div class="mb-3"><label>Senha</label><input type="password" id="reg-pass" class="form-control"
                            required></div>
                    <button class="btn btn-success w-100">Cadastrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Recover Password Modal (Insecure Display as Requested) -->
    <div class="modal fade" id="recover-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <h5 class="fw-bold mb-3">Recuperar Senha</h5>
                <p class="small text-muted">Informe seus dados para visualizar sua senha.</p>
                <form onsubmit="Auth.recover(event)">
                    <div class="mb-2"><input type="text" id="rec-cpf" class="form-control" placeholder="CPF" required>
                    </div>
                    <div class="mb-3"><input type="text" id="rec-nome" class="form-control" placeholder="Nome Completo"
                            required></div>
                    <button class="btn btn-primary w-100">Buscar Senha</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Modal + Gemini -->
    <div class="modal fade" id="cart-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold"><i class="fas fa-robot text-primary"></i> Assistente de Or√ßamento</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-list"></div>
                    <div class="alert alert-info mt-3 small">
                        <i class="fas fa-info-circle"></i> Compras abaixo de R$ 200 ganham <strong>30 pts</strong>.
                        Acima ganham <strong>60 pts</strong>.
                    </div>
                    <div id="gemini-box" class="p-3 bg-light rounded mt-3" style="display:none;"></div>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-outline-primary" onclick="Cart.getQuote()">Gerar Or√ßamento (IA)</button>
                        <button class="btn btn-success fw-bold" onclick="Cart.checkout()">Finalizar no WhatsApp</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal (Admin) -->
    <div class="modal fade" id="add-prod-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-4">
                <h5>Novo Produto</h5>
                <form onsubmit="Admin.addProduct(event)">
                    <input type="text" id="prod-name" class="form-control mb-2" placeholder="Nome" required>
                    <input type="text" id="prod-cat" class="form-control mb-2"
                        placeholder="Categoria (ex: motor, pneus)" required>
                    <input type="number" id="prod-price" class="form-control mb-2" placeholder="Pre√ßo" step="0.01"
                        required>
                    <input type="text" id="prod-img" class="form-control mb-2" placeholder="URL da Imagem (https://...)"
                        required>
                    <textarea id="prod-desc" class="form-control mb-2" placeholder="Descri√ß√£o"></textarea>
                    <button class="btn btn-success w-100">Salvar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="main-toast" class="toast align-items-center text-white bg-primary border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-msg"></div><button type="button"
                    class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- LIBS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- LOGIC -->
    <script>
        // --- DB SERVICE ---
        const DB = {
            client: null,
            init: function () {
                try {
                    this.client = supabase.createClient(AppConfig.supabaseUrl, AppConfig.supabaseKey);
                } catch (e) { console.error("DB Init Fail", e); }
            }
        };

        // --- AUTH SERVICE ---
        const Auth = {
            login: async function (e) {
                e.preventDefault();
                const email = document.getElementById('log-email').value.trim().toLowerCase();
                const pass = document.getElementById('log-pass').value.trim();

                const { data, error } = await DB.client.from('usuarios').select('*').eq('email', email).maybeSingle();

                if (data && data.senha === pass) {
                    this.setSession(data);
                    bootstrap.Modal.getInstance(document.getElementById('login-modal')).hide();
                    UI.toast(`Bem-vindo, ${data.nome}`);
                } else {
                    UI.toast("Email ou senha inv√°lidos", "bg-danger");
                }
            },
            register: async function (e) {
                e.preventDefault();
                const user = {
                    nome: document.getElementById('reg-nome').value.trim(),
                    email: document.getElementById('reg-email').value.trim().toLowerCase(),
                    cpf: document.getElementById('reg-cpf').value.trim(),
                    senha: document.getElementById('reg-pass').value.trim(),
                    pontos: 0,
                    is_admin: false
                };

                // Check Exists
                const { data: exists } = await DB.client.from('usuarios').select('id').or(`email.eq.${user.email},cpf.eq.${user.cpf}`).maybeSingle();
                if (exists) return UI.toast("Usu√°rio j√° existe!", "bg-warning");

                const { error } = await DB.client.from('usuarios').insert([user]);
                if (error) UI.toast("Erro ao cadastrar", "bg-danger");
                else {
                    UI.toast("Cadastro sucesso! Fa√ßa login.");
                    bootstrap.Modal.getInstance(document.getElementById('register-modal')).hide();
                }
            },
            recover: async function (e) {
                e.preventDefault();
                const cpf = document.getElementById('rec-cpf').value.trim();
                const nome = document.getElementById('rec-nome').value.trim();

                const { data } = await DB.client.from('usuarios').select('senha').eq('cpf', cpf).ilike('nome', nome).maybeSingle();
                if (data) alert(`Sua senha √©: ${data.senha}`);
                else UI.toast("Dados n√£o conferem", "bg-danger");
            },
            setSession: function (user) {
                State.user = user;
                localStorage.setItem('user', JSON.stringify(user));
                UI.updateAuth();
            },
            logout: function () {
                State.user = null;
                localStorage.removeItem('user');
                location.reload();
            }
        };

        // --- PRODUCTS SERVICE ---
        const Products = {
            list: [],
            load: async function () {
                const { data } = await DB.client.from('produtos').select('*');
                this.list = data || [];
                this.render();
            },
            render: function (items = this.list) {
                const grid = document.getElementById('products-grid');
                grid.innerHTML = '';
                if (items.length === 0) grid.innerHTML = '<div class="col-12 text-center py-5">Nenhum produto encontrado.</div>';

                items.forEach(p => {
                    const html = `
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="product-card h-100 d-flex flex-column">
                            <img src="${p.imagem_url}" class="product-img" onerror="this.src='https://placehold.co/300?text=Sem+Imagem'">
                            <div class="card-body d-flex flex-column flex-grow-1">
                                <h6 class="fw-bold mb-1">${p.nome}</h6>
                                <p class="small text-muted flex-grow-1">${p.descricao || ''}</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <span class="badge bg-secondary text-white" style="visibility:hidden">R$ ${p.preco}</span> <!-- Hidden Price -->
                                    <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="Cart.add(${p.id})">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    grid.innerHTML += html;
                });
            },
            filter: function (term) {
                const lower = term.toLowerCase();
                const start = this.list.filter(p => p.nome.toLowerCase().includes(lower));
                this.render(start);
            },
            filterCat: function (cat, btn) {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (cat === 'all') this.render();
                else this.render(this.list.filter(p => p.categoria === cat));
            }
        };

        // --- CART & ORDERS ---
        const Cart = {
            add: function (id) {
                const p = Products.list.find(x => x.id === id);
                if (p) {
                    State.cart.push(p);
                    this.save();
                    UI.toast(`${p.nome} adicionado!`);
                }
            },
            remove: function (idx) {
                State.cart.splice(idx, 1);
                this.save();
            },
            save: function () {
                localStorage.setItem('cart', JSON.stringify(State.cart));
                UI.updateCart();
            },
            getQuote: async function () {
                const box = document.getElementById('gemini-box');
                box.style.display = 'block';
                box.innerHTML = 'ü§ñ Calculando com Intelig√™ncia Artificial...';

                const items = State.cart.map(i => i.nome).join(', ');
                const prompt = `Gere um or√ßamento amig√°vel e t√©cnico para: ${items}. N√£o coloque valor un√≠t√°rio. Diga que √© uma excelente escolha.`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${AppConfig.geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    box.innerHTML = data.candidates?.[0]?.content?.parts?.[0]?.text || "Or√ßamento Gerado.";
                } catch (e) { box.innerHTML = "Or√ßamento pronto. Finalize abaixo."; }
            },
            checkout: async function () {
                if (!State.user) return UI.toast("Fa√ßa login para finalizar e ganhar pontos!", "bg-warning");
                if (State.cart.length === 0) return;

                const total = State.cart.reduce((a, b) => a + parseFloat(b.preco), 0);

                // 1. Create Pending Order in DB
                const order = {
                    user_id: State.user.id,
                    user_nome: State.user.nome,
                    items: State.cart, // Supabase stores JSON
                    total: total,
                    status: 'pendente'
                };

                const { data, error } = await DB.client.from('pedidos').insert([order]).select().single();

                if (error) {
                    console.error(error);
                    UI.toast("Erro ao registrar pedido. Tente novamente.", "bg-danger");
                    return;
                }

                // 2. Redirect WhatsApp
                const msg = `Ol√°! Sou ${State.user.nome}. Gostaria de confirmar o pedido #${data.id} contendo: ${State.cart.map(i => i.nome).join(', ')}.`;
                window.open(`https://wa.me/${AppConfig.whatsapp}?text=${encodeURIComponent(msg)}`, '_blank');

                State.cart = [];
                this.save();
                bootstrap.Modal.getInstance(document.getElementById('cart-modal')).hide();
                UI.toast("Pedido enviado! Aguarde aprova√ß√£o para ganhar pontos.");
            }
        };

        // --- ADMIN SERVICE ---
        const Admin = {
            openPanel: function () {
                new bootstrap.Offcanvas(document.getElementById('admin-panel')).show();
                this.loadOrders();
                this.loadStock();
            },
            loadOrders: async function () {
                const { data } = await DB.client.from('pedidos').select('*').eq('status', 'pendente').order('created_at', { ascending: false });
                const div = document.getElementById('admin-orders-list');
                div.innerHTML = '';
                if (!data || data.length === 0) div.innerHTML = '<p class="p-3 text-muted">Nenhum pedido pendente.</p>';
                else {
                    data.forEach(o => {
                        div.innerHTML += `
                        <div class="list-group-item">
                            <h6 class="fw-bold">#${o.id} - ${o.user_nome}</h6>
                            <small>R$ ${o.total.toFixed(2)}</small>
                            <button class="btn btn-sm btn-success w-100 mt-2" onclick="Admin.approve(${o.id}, ${o.total}, '${o.user_id}')">Confirmar & Dar Pontos</button>
                        </div>`;
                    });
                }
            },
            approve: async function (orderId, total, userId) {
                // Points Logic
                let points = (total >= 200) ? 60 : 30;

                // Update Order
                await DB.client.from('pedidos').update({ status: 'aprovado' }).eq('id', orderId);

                // Get current user points
                const { data: u } = await DB.client.from('usuarios').select('pontos').eq('id', userId).single();
                const newPoints = (u.pontos || 0) + points;

                // Update User
                await DB.client.from('usuarios').update({ pontos: newPoints }).eq('id', userId);

                UI.toast(`Pedido confirmado! +${points} pts para o cliente.`);
                this.loadOrders(); // Refresh
            },
            loadStock: function () {
                const div = document.getElementById('admin-products-list');
                div.innerHTML = '';
                Products.list.forEach(p => {
                    div.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${p.nome} <br> <small class="text-muted">R$ ${p.preco}</small></span>
                        <button class="btn btn-sm text-danger" onclick="Admin.delProd(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            },
            addProduct: async function (e) {
                e.preventDefault();
                const newP = {
                    nome: document.getElementById('prod-name').value,
                    categoria: document.getElementById('prod-cat').value,
                    preco: parseFloat(document.getElementById('prod-price').value),
                    descricao: document.getElementById('prod-desc').value,
                    imagem_url: document.getElementById('prod-img').value,
                    estoque: 10
                };
                const { error } = await DB.client.from('produtos').insert([newP]);
                if (!error) {
                    UI.toast("Produto Criado!");
                    Products.load();
                    bootstrap.Modal.getInstance(document.getElementById('add-prod-modal')).hide();
                }
            },
            delProd: async function (id) {
                if (confirm('Deletar produto?')) {
                    await DB.client.from('produtos').delete().eq('id', id);
                    Products.load();
                    this.loadStock();
                }
            }
        };

        // --- UI ---
        const UI = {
            init: function () {
                DB.init();
                Products.load();
                this.updateAuth();
                this.updateCart();
            },
            updateAuth: function () {
                const u = State.user;
                if (u) {
                    document.getElementById('nav-guest').style.display = 'none';
                    document.getElementById('nav-user').style.display = 'block';
                    document.getElementById('user-name').innerText = u.nome.split(' ')[0];
                    document.getElementById('user-points').innerText = u.pontos || 0;

                    if (u.pontos >= 1600) document.getElementById('gift-badge').style.display = 'block';
                    if (u.is_admin) document.getElementById('admin-link').style.display = 'block';
                } else {
                    document.getElementById('nav-guest').style.display = 'block';
                    document.getElementById('nav-user').style.display = 'none';
                }
            },
            updateCart: function () {
                const c = State.cart;
                document.getElementById('cart-count').innerText = c.length;

                const list = document.getElementById('cart-list');
                list.innerHTML = '';
                c.forEach((i, idx) => {
                    list.innerHTML += `<div class="d-flex justify-content-between border-bottom py-2">
                        <span>${i.nome}</span>
                        <a href="#" class="text-danger" onclick="Cart.remove(${idx})">X</a>
                    </div>`;
                });
            },
            modal: function (id) { new bootstrap.Modal(document.getElementById(id)).show(); },
            switchModal: function (curr, next) {
                bootstrap.Modal.getInstance(document.getElementById(curr)).hide();
                new bootstrap.Modal(document.getElementById(next)).show();
            },
            toast: function (msg, bg = 'bg-primary') {
                document.getElementById('toast-msg').innerText = msg;
                const t = document.getElementById('main-toast');
                t.className = `toast align-items-center text-white border-0 ${bg}`;
                new bootstrap.Toast(t).show();
            }
        };

        window.onload = () => UI.init();

    </script>
</body>

</html>
