<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arthur Auto Peças | Ultimate Edition</title>
    <!-- EXTENSIONS & FONTS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #475569;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-bs-theme="dark"] {
            --primary: #3b82f6;
            --glass: rgba(15, 23, 42, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --light: #1e293b;
            --text-body: #e2e8f0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--light);
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        .navbar-blur {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border-bottom: var(--glass-border);
            padding: 1rem 0;
            transition: var(--transition);
        }

        .nav-link {
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: var(--transition);
            transform: translateX(-50%);
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 80%;
        }

        .card-hover {
            border: none;
            border-radius: 20px;
            background: white;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            overflow: hidden;
            position: relative;
        }

        [data-bs-theme="dark"] .card-hover {
            background: #1e293b;
        }

        .card-hover:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 700;
            transition: var(--transition);
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }

        .hero-section {
            min-height: 80vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            position: relative;
            overflow: hidden;
            border-radius: 0 0 50px 50px;
            color: white;
            display: flex;
            align-items: center;
        }

        .hero-bg-accent {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.2) 0%, transparent 70%);
            top: -100px;
            right: -100px;
            border-radius: 50%;
            animation: pulse 10s infinite;
        }

        .chat-widget {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(120%);
            transition: var(--transition);
        }

        [data-bs-theme="dark"] .chat-widget {
            background: #1e293b;
            color: white;
        }

        .chat-open {
            transform: translateY(0);
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f1f5f9;
        }

        [data-bs-theme="dark"] .chat-body {
            background: #0f172a;
        }

        .msg {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 80%;
            font-size: 0.9rem;
        }

        .msg-ai {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            color: black;
        }

        .msg-user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 0.5;
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
    </style>
</head>

<body class="fade-in-up">

    <!-- CONFIG -->
    <script>
        const App = {
            config: {
                supabaseUrl: 'https://ydwxljgmzoqsemwemtml.supabase.co',
                supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkd3hsamdtem9xc2Vtd2VtdG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODM4ODEsImV4cCI6MjA4MDY1OTg4MX0.7elSMr11AHIhYayJgwqJQCpv0CdyiiM5XunW82Y-rAo',
                geminiKey: 'AIzaSyCO22vM99hmTcsUB6RwEqgDXcsO-UrO1VQ',
                whatsapp: '5585991815434',
                pixKey: '00.000.000/0001-00'
            },
            state: { user: JSON.parse(localStorage.getItem('user')) || null, cart: JSON.parse(localStorage.getItem('cart')) || [] }
        };
    </script>

    <!-- NAV -->
    <nav class="navbar navbar-expand-lg navbar-blur fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img src="public/logo.png" style="height: 48px;"
                    onerror="this.src='https://placehold.co/48x48?text=AAP'">
                <div><span class="fw-black d-block fs-5 text-primary">ARTHUR</span><small
                        class="text-uppercase text-muted" style="font-size:0.65rem;">Auto Peças</small></div>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarMain"><i class="bi bi-list fs-1 text-primary"></i></button>
            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item"><a class="nav-link active" href="#">Início</a></li>
                    <li class="nav-item"><a class="nav-link" href="#shop">Loja</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="Chatbot.toggle()">IA Mechanic</a></li>
                    <li class="nav-item d-none" id="nav-admin-link"><a class="nav-link text-warning fw-bold"
                            href="#admin-dashboard" onclick="UI.showAdmin()"><i class="bi bi-shield-lock-fill"></i>
                            Admin</a></li>
                </ul>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-secondary rounded-circle border-0" onclick="UI.toggleTheme()"><i
                            class="bi bi-moon-stars-fill"></i></button>
                    <button class="btn btn-outline-primary rounded-circle position-relative border-0"
                        onclick="Cart.open()"><i class="bi bi-bag-fill fs-5"></i><span
                            class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle"
                            id="cart-badge">0</span></button>
                    <div id="auth-container"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <section id="home" class="hero-section">
        <div class="hero-bg-accent"></div>
        <div class="container position-relative z-index-1">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-5 mb-lg-0 animate__animated animate__fadeInLeft">
                    <span
                        class="badge bg-white text-primary mb-3 px-3 py-2 rounded-pill fw-bold shadow-sm">Oficial</span>
                    <h1 class="display-3 fw-bolder mb-3">Sua Oficina <br><span class="text-primary">Inteligente</span>
                    </h1>
                    <p class="lead mb-4 text-white-50">Peças, Serviços e Consultoria com IA em um só lugar.</p>
                    <div class="d-flex gap-3"><a href="#shop" class="btn btn-gradient btn-lg">Ver Produtos</a></div>
                </div>
                <div class="col-lg-6 animate__animated animate__fadeInRight"><img
                        src="https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=800&q=80"
                        class="img-fluid rounded-4 shadow-lg border border-3 border-dark"></div>
            </div>
        </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="py-5">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <h2 class="fw-bold mb-0">Catálogo</h2>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar..."
                        oninput="Shop.search(this.value)">
                </div>
            </div>
            <div id="product-grid" class="row g-4"></div>
        </div>
    </section>

    <!-- ADMIN DASHBOARD -->
    <section id="admin-dashboard" class="d-none py-5 bg-light">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold"><i class="bi bi-shield-lock"></i> Gestão</h2>
                <button class="btn btn-outline-dark" onclick="location.reload()">Sair do Admin</button>
            </div>

            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Pedidos</h5>
                            <input type="text" id="admin-search-order" class="form-control w-25"
                                placeholder="Buscar Pedido #" oninput="Admin.load()">
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Pagamento</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-order-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CHATBOT -->
    <div id="chatbot" class="chat-widget shadow-lg">
        <div class="chat-header d-flex justify-content-between align-items-center" onclick="Chatbot.toggle()"><span><i
                    class="bi bi-robot me-2"></i>Mecânico Virtual</span><i class="bi bi-chevron-down"></i></div>
        <div class="chat-body" id="chat-messages">
            <div class="msg msg-ai">Olá! Pergunte sobre peças ou defeitos do seu carro.</div>
        </div>
        <div class="chat-input bg-white">
            <input type="text" id="chat-txt" class="form-control border-0 bg-light" placeholder="Dúvida..."
                onkeypress="if(event.key==='Enter') Chatbot.send()">
            <button class="btn btn-primary rounded-circle" onclick="Chatbot.send()"><i
                    class="bi bi-send-fill"></i></button>
        </div>
    </div>

    <!-- MODALS -->

    <!-- AUTH MODAL -->
    <div class="modal fade" id="auth-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-body p-4">
                    <div class="text-end"><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <ul class="nav nav-pills mb-3 justify-content-center">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill"
                                data-bs-target="#tab-login">Entrar</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill"
                                data-bs-target="#tab-register">Cadastrar</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-login">
                            <form onsubmit="Auth.login(event)">
                                <input type="email" class="form-control mb-3" id="login-email" placeholder="Email"
                                    required>
                                <input type="password" class="form-control mb-3" id="login-pass" placeholder="Senha"
                                    required>
                                <button class="btn btn-primary w-100 fw-bold">Entrar</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="tab-register">
                            <form onsubmit="Auth.register(event)">
                                <input class="form-control mb-2" id="reg-name" placeholder="Nome" required>
                                <input class="form-control mb-2" id="reg-email" placeholder="Email" required>
                                <input class="form-control mb-2" id="reg-cpf" placeholder="CPF" required>
                                <input class="form-control mb-3" id="reg-pass" placeholder="Senha" type="password"
                                    required>
                                <button class="btn btn-success w-100 fw-bold">Criar Conta</button>
                            </form>
                        </div>
                    </div>
                    <div id="auth-error" class="alert alert-danger mt-3 d-none small"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div class="modal fade" id="cart-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header">
                    <h5 class="fw-bold">Carrinho</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-items-container"></div>
                    <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mt-3">
                        <span class="fw-bold">Total:</span><span class="fw-bold fs-4" id="cart-total">R$ 0,00</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-primary" onclick="Cart.aiQuote()">✨ Orçamento IA</button>
                    <button class="btn btn-success fw-bold px-4" onclick="Cart.showCheckout()">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div class="modal fade" id="checkout-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Finalizar Pedido</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Como deseja pagar?</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success text-start p-3" onclick="Cart.setPayment('pix')">
                            <i class="bi bi-qr-code fs-4 me-2"></i> <strong>PIX</strong> (Aprovação rápida)
                        </button>
                        <button class="btn btn-outline-dark text-start p-3" onclick="Cart.setPayment('loja')">
                            <i class="bi bi-shop fs-4 me-2"></i> <strong>Pagar na Loja</strong> (Dinheiro/Cartão)
                        </button>
                    </div>

                    <div id="pix-info" class="d-none mt-3 p-3 bg-light border rounded text-center">
                        <p class="mb-1 text-muted">Chave PIX (CNPJ):</p>
                        <h4 class="font-monospace select-all"
                            onclick="navigator.clipboard.writeText(App.config.pixKey); alert('Copiado!')">
                            00.000.000/0001-00</h4>
                        <small class="text-danger">Envie o comprovante para o WhatsApp após confirmar.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary fw-bold" id="btn-confirm-order" disabled
                        onclick="Cart.submitOrder()">Confirmar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT ORDER MODAL (ADMIN) -->
    <div class="modal fade" id="edit-order-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Editar Pedido #<span id="edit-order-id"></span></h5><button class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Itens Atuais:</h6>
                    <ul class="list-group mb-3" id="edit-order-items"></ul>
                    <h6>Adicionar Item:</h6>
                    <div class="input-group">
                        <select class="form-select" id="edit-add-prod"></select>
                        <button class="btn btn-success" onclick="Admin.addItemToOrder()">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="Admin.saveOrderChanges()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-secondary border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-text"></div><button class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://md-block.verou.me/md-block.js" type="module"></script> <!-- Markdown Renderer -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- GOOGLE AI SDK IMPORT VIA MAP -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // GLOBAL SCOPE EXPOSURE
        window.App = {
            config: {
                supabaseUrl: 'https://ydwxljgmzoqsemwemtml.supabase.co',
                supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkd3hsamdtem9xc2Vtd2VtdG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODM4ODEsImV4cCI6MjA4MDY1OTg4MX0.7elSMr11AHIhYayJgwqJQCpv0CdyiiM5XunW82Y-rAo',
                geminiKey: 'AIzaSyCO22vM99hmTcsUB6RwEqgDXcsO-UrO1VQ',
                whatsapp: '5585991815434',
                pixKey: '00.000.000/0001-00'
            },
            state: { user: JSON.parse(localStorage.getItem('user')) || null, cart: JSON.parse(localStorage.getItem('cart')) || [], currentPayment: null }
        };

        // --- SERVICES ---
        const DB = supabase.createClient(App.config.supabaseUrl, App.config.supabaseKey);
        const GenAI = new GoogleGenerativeAI(App.config.geminiKey);
        const Model = GenAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // --- AUTH ---
        window.Auth = {
            async login(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const pass = document.getElementById('login-pass').value.trim();
                const errDiv = document.getElementById('auth-error');

                const { data, error } = await DB.from('usuarios').select('*').ilike('email', email).maybeSingle();

                if (error) { errDiv.innerText = "Erro DB: " + error.message; errDiv.classList.remove('d-none'); return; }
                if (!data) {
                    errDiv.innerHTML = "Usuário não encontrado.<br>Dica: Verifique se a tabela 'usuarios' existe no Supabase.";
                    errDiv.classList.remove('d-none'); return;
                }
                if (data.senha !== pass) { errDiv.innerText = "Senha incorreta."; errDiv.classList.remove('d-none'); return; }

                this.setSession(data);
                bootstrap.Modal.getInstance(document.getElementById('auth-modal')).hide();
                UI.showToast(`Bem-vindo, ${data.nome.split(' ')[0]}!`);
            },
            async register(e) {
                e.preventDefault();
                const user = {
                    nome: document.getElementById('reg-name').value.trim(),
                    email: document.getElementById('reg-email').value.trim().toLowerCase(),
                    cpf: document.getElementById('reg-cpf').value.trim(),
                    senha: document.getElementById('reg-pass').value.trim(),
                    pontos: 0,
                    is_admin: false
                };
                const { error } = await DB.from('usuarios').insert([user]);
                if (error) alert('Erro: ' + error.message);
                else { alert('Sucesso! Logue agora.'); location.reload(); } // Reload specifically requested to fix UI glitch
            },
            setSession(user) {
                App.state.user = user;
                localStorage.setItem('user', JSON.stringify(user));
                UI.updateAuth();
            },
            logout() {
                localStorage.removeItem('user');
                location.reload();
            }
        };

        // --- SHOP & CART ---
        window.Shop = {
            list: [],
            async init() {
                const { data } = await DB.from('produtos').select('*');
                this.list = data || [];
                this.render();
            },
            render(items = this.list) {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = items.map(p => `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card card-hover h-100">
                            <img src="${p.imagem_url}" class="card-img-top" style="height:150px; object-fit:cover" onerror="this.src='https://placehold.co/300'">
                            <div class="card-body">
                                <h6 class="fw-bold text-truncate">${p.nome}</h6>
                                <p class="small text-muted mb-2">R$ ${p.preco}</p>
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="Cart.add(${p.id})">Add</button>
                            </div>
                        </div>
                    </div>`).join('') || '<h4 class="text-center w-100 text-muted">Sem produtos :(</h4>';
            },
            search(q) { this.render(this.list.filter(p => p.nome.toLowerCase().includes(q.toLowerCase()))); }
        };

        window.Cart = {
            add(id) {
                const p = Shop.list.find(x => x.id === id);
                if (p) {
                    App.state.cart.push(p);
                    this.save();
                    UI.showToast("Adicionado!");
                }
            },
            remove(i) { App.state.cart.splice(i, 1); this.save(); },
            save() { localStorage.setItem('cart', JSON.stringify(App.state.cart)); UI.updateCart(); },
            open() { UI.modal('cart-modal'); },

            showCheckout() {
                if (!App.state.user) return UI.showToast("Faça login primeiro!", "bg-warning");
                if (App.state.cart.length === 0) return;
                bootstrap.Modal.getInstance(document.getElementById('cart-modal')).hide();
                UI.modal('checkout-modal');
                // Reset state
                document.getElementById('pix-info').classList.add('d-none');
                document.getElementById('btn-confirm-order').disabled = true;
            },

            setPayment(type) {
                App.state.currentPayment = type;
                document.getElementById('btn-confirm-order').disabled = false;
                document.getElementById('pix-info').classList.toggle('d-none', type !== 'pix');
            },

            async submitOrder() {
                const total = App.state.cart.reduce((a, b) => a + Number(b.preco), 0);
                const order = {
                    user_id: App.state.user.id,
                    user_nome: App.state.user.nome,
                    items: App.state.cart,
                    total: total,
                    status: 'pendente',
                    pagamento_metodo: App.state.currentPayment,
                    pagamento_status: 'aguardando'
                };

                // Insert DB
                const { data, error } = await DB.from('pedidos').insert([order]).select().single();

                if (error) {
                    console.error(error);
                    alert(`Erro ao salvar pedido: ${error.message}. Tente novamente ou contate o WhatsApp.`);
                    return;
                }

                // Success
                const orderId = data.id;
                bootstrap.Modal.getInstance(document.getElementById('checkout-modal')).hide();

                let msg = `✅ Pedido #${orderId} REALIZADO!\n`;
                msg += `Valor: R$ ${total.toFixed(2)}\n`;
                msg += `Prazo: 48h para retirada.\n`;
                if (App.state.currentPayment === 'pix') msg += `Envie o comprovante aqui no WhatsApp!`;
                else msg += `Pagamento na Loja selecionado.`;

                // Link
                window.open(`https://wa.me/${App.config.whatsapp}?text=${encodeURIComponent(msg)}`, '_blank');

                App.state.cart = [];
                this.save();
                UI.showToast("Pedido Gerado com Sucesso!");
            },

            async aiQuote() {
                const prompt = `Gere um orçamento técnico e persuasivo para estes itens: ${App.state.cart.map(i => i.nome).join(', ')}.`;
                try {
                    const result = await Model.generateContent(prompt);
                    const response = result.response.text();
                    alert(response); // Simple alert for now as requested by "simple"
                } catch (e) {
                    alert("Modo Offline: " + App.state.cart.map(i => i.nome).join(', '));
                }
            }
        };

        // --- ADMIN ---
        window.Admin = {
            currentEditId: null,
            async load() {
                const search = document.getElementById('admin-search-order').value;
                let query = DB.from('pedidos').select('*').order('created_at', { ascending: false });

                if (search) query = query.eq('id', search);

                const { data } = await query;
                const tbody = document.getElementById('admin-order-list');
                tbody.innerHTML = '';

                data?.forEach(o => {
                    tbody.innerHTML += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${o.user_nome}</td>
                        <td>R$ ${o.total}</td>
                        <td><span class="badge bg-${o.status === 'pendente' ? 'warning' : 'success'}">${o.status}</span></td>
                        <td>${o.pagamento_metodo}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="Admin.openEdit(${o.id})">Editar/Aprovar</button>
                        </td>
                    </tr>`;
                });
            },
            async openEdit(id) {
                this.currentEditId = id;
                const { data } = await DB.from('pedidos').select('*').eq('id', id).single();
                if (!data) return;

                document.getElementById('edit-order-id').innerText = id;
                const list = document.getElementById('edit-order-items');
                list.innerHTML = '';

                data.items.forEach((item, idx) => {
                    list.innerHTML += `<li class="list-group-item d-flex justify-content-between">${item.nome} <button class="btn btn-xs btn-danger" onclick="Admin.removeItem(${id}, ${idx})">X</button></li>`;
                });

                // Fill product select
                const sel = document.getElementById('edit-add-prod');
                sel.innerHTML = Shop.list.map(p => `<option value="${p.id}">${p.nome} - R$ ${p.preco}</option>`).join('');

                UI.modal('edit-order-modal');
            },
            async removeItem(orderId, itemIdx) {
                const { data } = await DB.from('pedidos').select('items').eq('id', orderId).single();
                data.items.splice(itemIdx, 1);
                // Recalc total hardcoded for now or fetch prices again
                // Update DB
                await DB.from('pedidos').update({ items: data.items }).eq('id', orderId);
                this.openEdit(orderId); // Reload
            },
            async addItemToOrder() {
                const prodId = document.getElementById('edit-add-prod').value;
                const p = Shop.list.find(x => x.id == prodId);

                const { data } = await DB.from('pedidos').select('items').eq('id', this.currentEditId).single();
                data.items.push(p);
                await DB.from('pedidos').update({ items: data.items }).eq('id', this.currentEditId);
                this.openEdit(this.currentEditId);
            },
            async saveOrderChanges() {
                // Determine new status?
                const approved = confirm("Aprovar pedido?");
                const status = approved ? 'aprovado' : 'pendente';

                // Recalc total
                const { data } = await DB.from('pedidos').select('items').eq('id', this.currentEditId).single();
                const total = data.items.reduce((a, b) => a + Number(b.preco), 0);

                await DB.from('pedidos').update({ status, total }).eq('id', this.currentEditId);

                bootstrap.Modal.getInstance(document.getElementById('edit-order-modal')).hide();
                this.load();
                UI.showToast("Pedido Atualizado!");
            }
        };

        // --- UI ---
        window.UI = {
            init() { Shop.init(); this.updateAuth(); this.updateCart(); },
            modal(id) { new bootstrap.Modal(document.getElementById(id)).show(); },
            showToast(msg, bg = 'bg-primary') {
                const el = document.getElementById('liveToast');
                el.className = `toast align-items-center text-white border-0 ${bg}`;
                document.getElementById('toast-text').innerText = msg;
                new bootstrap.Toast(el).show();
            },
            updateAuth() {
                const u = App.state.user;
                const c = document.getElementById('auth-container');
                if (u) {
                    if (u.is_admin) document.getElementById('nav-admin-link').classList.remove('d-none');
                    c.innerHTML = `<button class="btn btn-sm btn-light" onclick="Auth.logout()">Sair (${u.nome.split(' ')[0]})</button>`;
                } else {
                    c.innerHTML = `<button class="btn btn-gradient btn-sm" onclick="UI.modal('auth-modal')">Entrar</button>`;
                }
            },
            updateCart() {
                document.getElementById('cart-badge').innerText = App.state.cart.length;
                const list = document.getElementById('cart-items-container');
                list.innerHTML = App.state.cart.map((p, i) => `
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <span>${p.nome}</span> <button class="btn btn-link text-danger p-0" onclick="Cart.remove(${i})">x</button>
                    </div>`).join('');
                const total = App.state.cart.reduce((a, b) => a + Number(b.preco), 0);
                document.getElementById('cart-total').innerText = 'R$ ' + total.toFixed(2);
            },
            showAdmin() {
                document.getElementById('home').classList.add('d-none');
                document.getElementById('shop').classList.add('d-none');
                document.getElementById('admin-dashboard').classList.remove('d-none');
                Admin.load();
            },
            toggleTheme() {
                const html = document.documentElement;
                const next = html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-bs-theme', next);
            }
        };

        // --- CHATBOT ---
        window.Chatbot = {
            isOpen: false,
            toggle() { this.isOpen = !this.isOpen; document.getElementById('chatbot').classList.toggle('chat-open', this.isOpen); },
            async send() {
                const inp = document.getElementById('chat-txt');
                const txt = inp.value;
                if (!txt) return;

                this.addMsg(txt, 'user');
                inp.value = '';

                try {
                    const result = await Model.generateContent(txt);
                    this.addMsg(result.response.text(), 'ai');
                } catch (e) {
                    this.addMsg("Estou offline no momento. Tente mais tarde!", 'ai');
                }
            },
            addMsg(txt, role) {
                const d = document.createElement('div');
                d.className = `msg msg-${role}`;
                d.innerText = txt;
                document.getElementById('chat-messages').append(d);
            }
        };

        UI.init();
    </script>
</body>

</html>
