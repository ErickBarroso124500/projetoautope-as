<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Arthur Auto Pe√ßas - A evolu√ß√£o da sua experi√™ncia automotiva.">
    <title>Arthur Auto Pe√ßas | Ultimate Edition</title>

    <!-- EXTENSIONS & FONTS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- CORE STYLE SYSTEM -->
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #475569;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-bs-theme="dark"] {
            --primary: #3b82f6;
            --glass: rgba(15, 23, 42, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --light: #1e293b;
            --text-body: #e2e8f0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--light);
            overflow-x: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 4px;
        }

        /* NAVBAR PREMIUM */
        .navbar-blur {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border-bottom: var(--glass-border);
            padding: 1rem 0;
            transition: var(--transition);
        }

        .nav-link {
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: var(--transition);
            transform: translateX(-50%);
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 80%;
        }

        /* COMPONENTS */
        .card-hover {
            border: none;
            border-radius: 20px;
            background: white;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            overflow: hidden;
            position: relative;
        }

        [data-bs-theme="dark"] .card-hover {
            background: #1e293b;
        }

        .card-hover:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 700;
            transition: var(--transition);
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }

        /* HERO SECTION */
        .hero-section {
            min-height: 80vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            position: relative;
            overflow: hidden;
            border-radius: 0 0 50px 50px;
            color: white;
            display: flex;
            align-items: center;
        }

        .hero-bg-accent {
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.2) 0%, transparent 70%);
            top: -100px;
            right: -100px;
            border-radius: 50%;
            animation: pulse 10s infinite;
        }

        /* LOYALTY PROGRESS */
        .loyalty-card {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: black;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(184, 134, 11, 0.3);
        }

        /* CHATBOT */
        .chat-widget {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(120%);
            transition: var(--transition);
        }

        [data-bs-theme="dark"] .chat-widget {
            background: #1e293b;
            color: white;
        }

        .chat-open {
            transform: translateY(0);
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .chat-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f1f5f9;
        }

        [data-bs-theme="dark"] .chat-body {
            background: #0f172a;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
        }

        .msg {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 80%;
            font-size: 0.9rem;
        }

        .msg-ai {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .msg-user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        /* ADMIN CHARTS */
        .chart-bar {
            height: 10px;
            border-radius: 5px;
            background: #e2e8f0;
            margin-top: 5px;
            overflow: hidden;
        }

        .chart-fill {
            height: 100%;
            background: var(--primary);
            width: 0;
            transition: width 1s ease-out;
        }

        /* TOAST & NOTIFICATIONS */
        .toast-container {
            z-index: 1100;
        }

        /* ANIMATIONS */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 0.5;
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="fade-in-up">

    <!-- CONFIGURATIONS -->
    <script>
        const App = {
            config: {
                supabaseUrl: 'https://ydwxljgmzoqsemwemtml.supabase.co',
                supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkd3hsamdtem9xc2Vtd2VtdG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODM4ODEsImV4cCI6MjA4MDY1OTg4MX0.7elSMr11AHIhYayJgwqJQCpv0CdyiiM5XunW82Y-rAo',
                geminiKey: 'AIzaSyCO22vM99hmTcsUB6RwEqgDXcsO-UrO1VQ',
                whatsapp: '5585991815434'
            },
            state: {
                user: JSON.parse(localStorage.getItem('user')) || null,
                cart: JSON.parse(localStorage.getItem('cart')) || [],
                wishlist: JSON.parse(localStorage.getItem('wishlist')) || [],
                products: [],
                orders: [],
                token: null
            }
        };
    </script>

    <!-- NAVIGATION -->
    <nav class="navbar navbar-expand-lg navbar-blur fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img src="public/logo.png" style="height: 48px;"
                    onerror="this.src='https://placehold.co/48x48?text=AAP'">
                <div style="line-height:1.1">
                    <span class="fw-black d-block fs-5 text-primary">ARTHUR</span>
                    <small class="text-uppercase text-muted" style="font-size:0.65rem; letter-spacing: 2px;">Auto
                        Pe√ßas</small>
                </div>
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarMain">
                <i class="bi bi-list fs-1 text-primary"></i>
            </button>

            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item"><a class="nav-link active" href="#home">In√≠cio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#shop">Loja</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="Chatbot.toggle()">IA Mechanic</a></li>
                    <!-- IF ADMIN -->
                    <li class="nav-item d-none" id="nav-admin-link">
                        <a class="nav-link text-warning fw-bold" href="#admin-dashboard" onclick="UI.showAdmin()"><i
                                class="bi bi-shield-lock-fill"></i> Admin</a>
                    </li>
                </ul>

                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-secondary rounded-circle border-0" onclick="UI.toggleTheme()">
                        <i class="bi bi-moon-stars-fill"></i>
                    </button>

                    <button class="btn btn-outline-primary rounded-circle position-relative border-0"
                        onclick="Cart.open()">
                        <i class="bi bi-bag-fill fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                            id="cart-badge">0</span>
                    </button>

                    <!-- User Account -->
                    <div class="dropdown" id="auth-container">
                        <!-- Filled by JS -->
                        <button class="btn btn-gradient shadow-sm" onclick="UI.modal('auth-modal')">Entrar</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- HERO HEADER -->
    <section id="home" class="hero-section">
        <div class="hero-bg-accent"></div>
        <div class="container position-relative z-index-1">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-5 mb-lg-0 animate__animated animate__fadeInLeft">
                    <span class="badge bg-white text-primary mb-3 px-3 py-2 rounded-pill fw-bold shadow-sm">
                        <i class="bi bi-award-fill me-1"></i> A Melhor da Regi√£o
                    </span>
                    <h1 class="display-3 fw-bolder mb-3">Pe√ßas Premium para <br><span class="text-primary">Performance
                            Real</span></h1>
                    <p class="lead mb-4 text-white-50">Encontre a pe√ßa exata para seu ve√≠culo com a ajuda da nossa
                        Intelig√™ncia Artificial Exclusiva.</p>
                    <div class="d-flex gap-3">
                        <a href="#shop" class="btn btn-gradient btn-lg">Explorar Cat√°logo</a>
                        <button onclick="Chatbot.toggle()" class="btn btn-outline-light btn-lg border-2 fw-bold">Falar
                            com Mec√¢nico IA</button>
                    </div>
                </div>
                <div class="col-lg-6 position-relative animate__animated animate__fadeInRight">
                    <img src="https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=800&q=80"
                        class="img-fluid rounded-4 shadow-lg border border-3 border-dark" alt="Super Car">

                    <!-- Floating Stat Card -->
                    <div class="card position-absolute bottom-0 start-0 mb-4 ms-n4 border-0 shadow-lg p-3 animate__animated animate__rubberBand"
                        style="max-width: 200px;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-success text-white rounded-circle p-2"><i class="bi bi-check-lg"></i></div>
                            <div>
                                <h6 class="mb-0 fw-bold">Estoque Real</h6>
                                <small class="text-muted">Atualizado Agora</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SHOP SECTION -->
    <section id="shop" class="py-5">
        <div class="container">
            <!-- Filters -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <h2 class="fw-bold mb-0">Cat√°logo <span class="text-primary">Premium</span></h2>

                <div class="d-flex gap-2 overflow-auto pb-2">
                    <button class="btn btn-outline-secondary rounded-pill active"
                        onclick="Shop.filter('all', this)">Todos</button>
                    <button class="btn btn-outline-secondary rounded-pill"
                        onclick="Shop.filter('pneus', this)">Pneus</button>
                    <button class="btn btn-outline-secondary rounded-pill"
                        onclick="Shop.filter('motor', this)">Motor</button>
                    <button class="btn btn-outline-secondary rounded-pill"
                        onclick="Shop.filter('freios', this)">Freios</button>
                </div>

                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar pe√ßa..."
                        oninput="Shop.search(this.value)">
                </div>
            </div>

            <!-- Grid -->
            <div id="product-grid" class="row g-4">
                <!-- Products injected here -->
            </div>
        </div>
    </section>

    <!-- ADMIN DASHBOARD (Hidden) -->
    <section id="admin-dashboard" class="d-none py-5 bg-light">
        <div class="container">
            <h2 class="fw-bold mb-4"><i class="bi bi-speedometer2"></i> Portal do Administrador</h2>

            <div class="row g-4">
                <!-- Stats -->
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-3">
                        <small class="text-muted text-uppercase fw-bold">Pedidos Pendentes</small>
                        <h3 class="fw-bold text-primary" id="stat-pending">0</h3>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-3">
                        <small class="text-muted text-uppercase fw-bold">Faturamento (Simulado)</small>
                        <h3 class="fw-bold text-success" id="stat-revenue">R$ 0,00</h3>
                    </div>
                </div>

                <!-- Stock Manager -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Estoque & Produtos</h5>
                            <button class="btn btn-sm btn-primary" onclick="UI.modal('prod-modal')"><i
                                    class="bi bi-plus-lg"></i> Adicionar</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Produto</th>
                                            <th>Categoria</th>
                                            <th>Pre√ßo</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-prod-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Manager -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0">
                            <h5 class="mb-0 fw-bold">Pedidos Aguardando Aprova√ß√£o</h5>
                        </div>
                        <div class="card-body" id="admin-order-list">
                            <!-- Orders go here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CHATBOT WIDGET -->
    <div id="chatbot" class="chat-widget shadow-lg">
        <div class="chat-header d-flex justify-content-between align-items-center" onclick="Chatbot.toggle()">
            <span><i class="bi bi-robot me-2"></i>Mec√¢nico Virtual</span>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="chat-body" id="chat-messages">
            <div class="d-flex flex-column">
                <div class="msg msg-ai">Ol√°! Eu sou a IA da Arthur Pe√ßas. Posso ajudar com dicas de manuten√ß√£o,
                    or√ßamento ou d√∫vidas sobre pe√ßas. Como posso ajudar?</div>
            </div>
        </div>
        <div class="chat-input bg-white">
            <input type="text" id="chat-txt" class="form-control border-0 bg-light" placeholder="Digite sua d√∫vida..."
                onkeypress="if(event.key==='Enter') Chatbot.send()">
            <button class="btn btn-primary rounded-circle" onclick="Chatbot.send()"><i
                    class="bi bi-send-fill"></i></button>
        </div>
    </div>

    <!-- MODALS -->

    <!-- AUTH MODAL -->
    <div class="modal fade" id="auth-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 overflow-hidden">
                <div class="modal-body p-0 d-flex">
                    <div
                        class="d-none d-md-block bg-primary text-white p-5 col-5 d-flex flex-column justify-content-center">
                        <h4>Bem-vindo de volta!</h4>
                        <p class="small opacity-75">Acesse sua conta para ver seus pontos e pedidos.</p>
                    </div>
                    <div class="p-4 col-12 col-md-7">
                        <div class="text-end"><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill"
                                    data-bs-target="#tab-login">Login</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill"
                                    data-bs-target="#tab-register">Cadastro</button></li>
                        </ul>

                        <div class="tab-content">
                            <!-- LOGIN -->
                            <div class="tab-pane fade show active" id="tab-login">
                                <form onsubmit="Auth.login(event)">
                                    <div class="form-floating mb-3">
                                        <input type="email" class="form-control" id="login-email"
                                            placeholder="nome@exemplo.com" required>
                                        <label>Email</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input type="password" class="form-control" id="login-pass" placeholder="Senha"
                                            required>
                                        <label>Senha</label>
                                    </div>
                                    <button class="btn btn-primary w-100 py-2 fw-bold">Entrar</button>
                                    <div class="text-center mt-3">
                                        <a href="#" class="small text-muted" onclick="Auth.recoverPrompt()">Esqueceu a
                                            senha?</a>
                                    </div>
                                </form>
                            </div>
                            <!-- REGISTER -->
                            <div class="tab-pane fade" id="tab-register">
                                <form onsubmit="Auth.register(event)">
                                    <div class="mb-2"><input type="text" class="form-control" id="reg-name"
                                            placeholder="Nome Completo" required></div>
                                    <div class="mb-2"><input type="email" class="form-control" id="reg-email"
                                            placeholder="Email" required></div>
                                    <div class="mb-2"><input type="text" class="form-control" id="reg-cpf"
                                            placeholder="CPF" required></div>
                                    <div class="mb-3"><input type="password" class="form-control" id="reg-pass"
                                            placeholder="Senha" required></div>
                                    <button class="btn btn-success w-100 py-2 fw-bold">Criar Conta</button>
                                </form>
                            </div>
                        </div>
                        <div id="auth-error" class="alert alert-danger mt-3 d-none small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div class="modal fade" id="cart-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold">Seu Carrinho</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-items-container"></div>

                    <div class="bg-light p-3 rounded mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Subtotal Estimado:</span>
                            <span class="fw-bold fs-5" id="cart-total">R$ 0,00</span>
                        </div>
                        <div class="d-flex justify-content-between text-muted small">
                            <span>Pontos a ganhar:</span>
                            <span class="fw-bold text-success">+<span id="cart-points">0</span> pts</span>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3 d-flex gap-2 align-items-center">
                        <i class="bi bi-magic fs-4"></i>
                        <small>Use a IA para gerar um or√ßamento formatado antes de enviar.</small>
                    </div>

                    <div id="ai-quote-box" class="p-3 border rounded bg-white mb-3 d-none font-monospace small"></div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-outline-primary" onclick="Cart.aiQuote()">Gerar c/ IA</button>
                    <button class="btn btn-success fw-bold px-4" onclick="Cart.checkout()">Finalizar (WhatsApp)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODUCT DETAIL MODAL -->
    <div class="modal fade" id="prod-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <h5>Novo Produto (Admin)</h5>
                    <form onsubmit="Admin.saveProd(event)">
                        <input class="form-control mb-2" id="ap-name" placeholder="Nome" required>
                        <input class="form-control mb-2" id="ap-cat" placeholder="Categoria (slug: pneus, motor)"
                            required>
                        <input type="number" class="form-control mb-2" id="ap-price" placeholder="Pre√ßo" required>
                        <input class="form-control mb-2" id="ap-img" placeholder="URL Imagem" required>
                        <textarea class="form-control mb-2" id="ap-desc" placeholder="Descri√ß√£o"></textarea>
                        <button class="btn btn-dark w-100">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TOASTS -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white bg-dark border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-text"></div><button type="button"
                    class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- EXTERNAL LIBS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdsp.github.io/canvasjs-charts/canvasjs.min.js"></script>
    <!-- Placeholder for charts if needed, using CSS instead for minimal dependency -->

    <!-- APPLICATION LOGIC -->
    <script>
        /**
         * CORE SERVICES
         */
        const DB = {
            client: null,
            init: function () {
                try {
                    this.client = supabase.createClient(App.config.supabaseUrl, App.config.supabaseKey);
                    console.log('Database Connected');
                } catch (e) {
                    UI.showToast("Erro cr√≠tico: Banco de dados offline", "bg-danger");
                }
            }
        };

        const Auth = {
            async login(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const pass = document.getElementById('login-pass').value.trim();
                const errDiv = document.getElementById('auth-error');

                console.log("Tentando login para:", email);

                const { data, error } = await DB.client.from('usuarios')
                    .select('*')
                    .ilike('email', email)
                    .maybeSingle();

                console.log("Login Query Res:", data, error);

                if (error) {
                    errDiv.innerText = "Erro DB: " + error.message;
                    errDiv.classList.remove('d-none');
                    return;
                }

                if (!data) {
                    // HELP THE USER: This is likely RLS or Typo
                    errDiv.innerHTML = `<strong>Usu√°rio n√£o encontrado.</strong><br>
                    Poss√≠veis causas:<br>
                    1. Email errado.<br>
                    2. <strong>Supabase RLS bloqueando leitura (Muito prov√°vel).</strong><br>
                    3. Conta ainda n√£o criada.<br>
                    <small>Dica: V√° no Supabase > Authentication > Policies e desative RLS da tabela 'usuarios' ou adicione pol√≠tica de leitura p√∫blica.</small>`;

                    errDiv.classList.remove('d-none');
                    return;
                }

                if (data.senha !== pass) {
                    errDiv.innerText = "Senha incorreta.";
                    errDiv.classList.remove('d-none');
                    return;
                }

                // Success
                this.setSession(data);
                bootstrap.Modal.getInstance(document.getElementById('auth-modal')).hide();
                UI.showToast(`Bem-vindo, ${data.nome.split(' ')[0]}!`);
            },

            async register(e) {
                e.preventDefault();
                const user = {
                    nome: document.getElementById('reg-name').value.trim(),
                    email: document.getElementById('reg-email').value.trim().toLowerCase(),
                    cpf: document.getElementById('reg-cpf').value.trim(),
                    senha: document.getElementById('reg-pass').value.trim(),
                    pontos: 0,
                    is_admin: false
                };

                const { data: exists } = await DB.client.from('usuarios').select('id').eq('email', user.email).maybeSingle();
                if (exists) { alert('Email j√° existe.'); return; }

                const { error } = await DB.client.from('usuarios').insert([user]);
                if (error) alert('Erro ao criar: ' + error.message);
                else {
                    alert('Conta criada! Fa√ßa login.');
                    document.querySelector('#pills-tab button[data-bs-target="#tab-login"]').click();
                }
            },

            recoverPrompt() {
                const cpf = prompt("Digite seu CPF para ver sua senha:");
                const nome = prompt("Digite seu Nome para confirmar:");
                if (!cpf || !nome) return;

                DB.client.from('usuarios').select('senha').eq('cpf', cpf).ilike('nome', `%${nome}%`).maybeSingle()
                    .then(({ data }) => {
                        if (data) alert(`Sua senha √©: ${data.senha}`);
                        else alert("Dados n√£o encontrados (verifique RLS se tiver certeza).");
                    });
            },

            setSession(user) {
                App.state.user = user;
                localStorage.setItem('user', JSON.stringify(user));
                UI.updateAuth();
            },

            logout() {
                App.state.user = null;
                localStorage.removeItem('user');
                location.reload();
            }
        };

        const Services = {
            async getGeminiResponse(prompt) {
                const key = App.config.geminiKey;
                // List of models to try in order
                const models = ['gemini-1.5-flash', 'gemini-pro', 'gemini-1.0-pro'];

                for (const model of models) {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (res.ok) {
                            const json = await res.json();
                            return json.candidates?.[0]?.content?.parts?.[0]?.text || "IA sem resposta.";
                        } else {
                            // warn but continue loop
                            console.warn(`Model ${model} failed.. moving to next.`);
                        }
                    } catch (e) {
                        console.warn(`Connection error with ${model}`);
                    }
                }

                // FALLBACK LOCAL AI (If all APIs fail)
                return this.localFallback(prompt);
            },

            localFallback(prompt) {
                // Heuristic to guess context
                if (prompt.includes('Or√ßamento')) {
                    const items = App.state.cart.map(i => `- ${i.nome} (R$ ${i.preco})`).join('<br>');
                    const total = App.state.cart.reduce((a, b) => a + Number(b.preco), 0).toFixed(2);
                    return `<strong>(Modo Offline) Or√ßamento Estimado:</strong><br><br>${items}<br><br><strong>Total: R$ ${total}</strong><br><small>Obs: A IA est√° indispon√≠vel, mas seus itens est√£o garantidos.</small>`;
                }
                return "A IA est√° dormindo agora üò¥, mas nosso mec√¢nico humano responde no WhatsApp!";
            }
        };

        /**
         * MODULES
         */
        const Shop = {
            list: [],
            async init() {
                // Load products from DB
                const { data, error } = await DB.client.from('produtos').select('*');
                if (!error) this.list = data;
                else this.list = [];
                this.render();
            },
            render(items = this.list) {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';

                if (items.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center py-5 text-muted"><h3>Nada encontrado :(</h3></div>';
                    return;
                }

                items.forEach(p => {
                    const card = `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card card-hover h-100">
                            <div class="position-relative" style="height: 180px; overflow: hidden;">
                                <img src="${p.imagem_url}" class="w-100 h-100 object-fit-cover" onerror="this.src='https://placehold.co/300'">
                                <div class="position-absolute top-0 end-0 m-2 badge bg-dark opacity-75">${p.categoria}</div>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="fw-bold text-truncate">${p.nome}</h6>
                                <p class="small text-muted mb-2 flex-grow-1" style="font-size: 0.8rem; line-height: 1.2;">
                                    ${p.descricao ? p.descricao.substring(0, 50) + '...' : 'Qualidade Garantida'}
                                </p>
                                <button class="btn btn-outline-primary btn-sm rounded-pill mt-auto w-100" onclick="Cart.add(${p.id})">
                                    <i class="bi bi-cart-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    </div>`;
                    grid.innerHTML += card;
                });
            },
            filter(cat, btn) {
                // UI Toggle
                btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active', 'bg-primary', 'text-white'));
                btn.classList.add('active', 'bg-primary', 'text-white');

                if (cat === 'all') this.render();
                else this.render(this.list.filter(p => p.categoria === cat));
            },
            search(query) {
                const q = query.toLowerCase();
                this.render(this.list.filter(p => p.nome.toLowerCase().includes(q)));
            }
        };

        const Cart = {
            add(id) {
                const p = Shop.list.find(x => x.id === id);
                if (p) {
                    App.state.cart.push(p);
                    this.save();
                    UI.showToast("Adicionado ao carrinho!");
                }
            },
            remove(idx) {
                App.state.cart.splice(idx, 1);
                this.save();
            },
            save() {
                localStorage.setItem('cart', JSON.stringify(App.state.cart));
                UI.updateCart();
            },
            open() {
                UI.modal('cart-modal');
            },
            async aiQuote() {
                const box = document.getElementById('ai-quote-box');
                box.classList.remove('d-none');
                box.innerHTML = '‚ú® A IA est√° analisando compatibilidade e gerando o or√ßamento...';

                const items = App.state.cart.map(i => i.nome).join(', ');
                const prompt = `Atue como um especialista em pe√ßas da Arthur Auto Pe√ßas. Gere um or√ßamento elegante para: ${items}.
                Inclua uma dica t√©cnica sobre uma das pe√ßas. N√£o invente pre√ßos, diga "Pre√ßos de Cat√°logo".`;

                const text = await Services.getGeminiResponse(prompt);
                box.innerHTML = text.replace(/\n/g, '<br>');
            },
            async checkout() {
                if (!App.state.user) { UI.showToast("Entre para ganhar pontos!", "bg-warning"); return; }

                const total = App.state.cart.reduce((a, b) => a + Number(b.preco), 0);
                const orderData = {
                    user_id: App.state.user.id,
                    user_nome: App.state.user.nome,
                    items: App.state.cart,
                    total: total,
                    status: 'pendente'
                };

                // TRY DB SAVE (BUT DON'T BLOCK IF FAILS)
                let orderId = 'ZAP-' + Math.floor(Math.random() * 1000);

                try {
                    const { data, error } = await DB.client.from('pedidos').insert([orderData]).select().single();
                    if (!error && data) {
                        orderId = '#' + data.id;
                        UI.showToast("Pedido salvo no sistema!");
                    } else {
                        console.warn("DB Save Failed (Table Missing/RLS?), proceeding with WhatsApp only.");
                        UI.showToast("Erro no Banco de Dados. Finalizando via WhatsApp...", "bg-warning");
                    }
                } catch (e) {
                    console.error("DB Critical Error", e);
                }

                // ALWAYS PROCEED TO WHATSAPP
                const msg = `Pedido ${orderId} iniciado!
                Itens: ${App.state.cart.map(i => i.nome).join(', ')}.
                Total Estimado: R$ ${total.toFixed(2)}
                Cliente: ${App.state.user.nome}`;

                window.open(`https://wa.me/${App.config.whatsapp}?text=${encodeURIComponent(msg)}`, '_blank');

                App.state.cart = [];
                this.save();
                bootstrap.Modal.getInstance(document.getElementById('cart-modal')).hide();
            }
        };

        const Chatbot = {
            isOpen: false,
            toggle() {
                this.isOpen = !this.isOpen;
                document.getElementById('chatbot').classList.toggle('chat-open', this.isOpen);
            },
            async send() {
                const input = document.getElementById('chat-txt');
                const txt = input.value.trim();
                if (!txt) return;

                this.appendMsg(txt, 'user');
                input.value = '';

                // Call Gemini
                this.appendMsg('Digitando...', 'ai', 'temp-typing');
                const prompt = `Voc√™ √© um mec√¢nico virtual da Arthur Auto Pe√ßas. Seja curto e √∫til. Cliente perguntou: ${txt}`;
                const response = await Services.getGeminiResponse(prompt);

                document.querySelector('.temp-typing')?.remove();
                this.appendMsg(response, 'ai');
            },
            appendMsg(txt, role, extraClass = '') {
                const box = document.getElementById('chat-messages').firstElementChild;
                const div = document.createElement('div');
                div.className = `msg msg-${role} ${extraClass}`;
                div.innerText = txt;
                box.appendChild(div);
                document.getElementById('chat-messages').scrollTop = 9999;
            }
        };

        const Admin = {
            async load() {
                if (!App.state.user?.is_admin) return;

                // Load Products
                Shop.render(Shop.list); // Actually admin needs a table
                const table = document.getElementById('admin-prod-list');
                table.innerHTML = '';
                Shop.list.forEach(p => {
                    table.innerHTML += `<tr>
                        <td>${p.nome}</td>
                        <td><span class="badge bg-secondary">${p.categoria}</span></td>
                        <td>R$${p.preco}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="Admin.del(${p.id})">X</button></td>
                    </tr>`;
                });

                // Load Orders
                const { data } = await DB.client.from('pedidos').select('*').eq('status', 'pendente').order('created_at', { ascending: false });
                const list = document.getElementById('admin-order-list');
                list.innerHTML = '';

                document.getElementById('stat-pending').innerText = data?.length || 0;

                if (data && data.length) {
                    data.forEach(o => {
                        list.innerHTML += `
                        <div class="alert alert-warning d-flex justify-content-between align-items-center">
                            <div>
                                <strong>#${o.id}</strong> - ${o.user_nome}<br>
                                <span class="small">${o.items.length} itens - R$ ${o.total}</span>
                            </div>
                            <button class="btn btn-success btn-sm fw-bold" onclick="Admin.approve(${o.id}, ${o.total}, '${o.user_id}')">Aprovar ></button>
                        </div>`;
                    });
                } else {
                    list.innerHTML = 'Nenhum pedido pendente.';
                }
            },

            async approve(oId, total, uId) {
                const pts = total >= 200 ? 60 : 30;

                await DB.client.from('pedidos').update({ status: 'aprovado' }).eq('id', oId);

                const { data: u } = await DB.client.from('usuarios').select('pontos').eq('id', uId).single();
                await DB.client.from('usuarios').update({ pontos: (u.pontos || 0) + pts }).eq('id', uId);

                UI.showToast(`Aprovado! +${pts} pts para o cliente.`);
                this.load();
            },

            async del(id) {
                if (confirm('Excluir?')) {
                    await DB.client.from('produtos').delete().eq('id', id);
                    Shop.init();
                    this.load();
                }
            },

            async saveProd(e) {
                e.preventDefault();
                const p = {
                    nome: document.getElementById('ap-name').value,
                    categoria: document.getElementById('ap-cat').value,
                    preco: document.getElementById('ap-price').value,
                    imagem_url: document.getElementById('ap-img').value,
                    descricao: document.getElementById('ap-desc').value,
                    estoque: 10
                };
                await DB.client.from('produtos').insert([p]);
                Shop.init();
                this.load();
                bootstrap.Modal.getInstance(document.getElementById('prod-modal')).hide();
            }
        };

        const UI = {
            init() {
                DB.init();
                Shop.init();
                this.updateAuth();
                this.updateCart();
                if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-bs-theme', 'dark');
            },

            updateAuth() {
                const u = App.state.user;
                const container = document.getElementById('auth-container');

                if (u) {
                    const points = u.pontos || 0;
                    const nextLevel = 1600;
                    const percent = Math.min(100, (points / nextLevel) * 100);

                    if (u.is_admin) document.getElementById('nav-admin-link').classList.remove('d-none');

                    container.innerHTML = `
                        <button class="btn btn-light dropdown-toggle d-flex align-items-center gap-2 border" data-bs-toggle="dropdown">
                            <div class="d-flex flex-column text-start" style="line-height:1">
                                <span class="fw-bold small">${u.nome.split(' ')[0]}</span>
                                <span class="text-warning" style="font-size:0.7rem">‚òÖ ${points} pts</span>
                            </div>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-3" style="width: 250px">
                            <li>
                                <h6 class="dropdown-header">Fidelidade</h6>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-warning" style="width: ${percent}%"></div>
                                </div>
                                <small class="text-muted d-block mt-1 text-center">${points} / 1600 para Brinde</small>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger rounded" href="#" onclick="Auth.logout()"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
                        </ul>
                    `;
                } else {
                    container.innerHTML = `<button class="btn btn-gradient shadow-sm" onclick="this.parentElement.innerHTML=''; UI.modal('auth-modal')">Entrar</button>`;
                }
            },

            updateCart() {
                const c = App.state.cart;
                document.getElementById('cart-badge').innerText = c.length;

                const list = document.getElementById('cart-items-container');
                list.innerHTML = '';

                let total = 0;
                c.forEach((p, i) => {
                    total += Number(p.preco);
                    list.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2 animate__animated animate__fadeIn">
                            <div class="d-flex align-items-center gap-2">
                                <img src="${p.imagem_url}" width="40" height="40" class="rounded object-fit-cover">
                                <div style="line-height:1">
                                    <span class="d-block fw-bold small">${p.nome}</span>
                                    <small class="text-muted">R$ ${p.preco}</small>
                                </div>
                            </div>
                            <button class="btn btn-link text-danger p-0" onclick="Cart.remove(${i})"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                });

                document.getElementById('cart-total').innerText = 'R$ ' + total.toFixed(2);
                document.getElementById('cart-points').innerText = total >= 200 ? '60' : '30';
            },

            toggleTheme() {
                const html = document.documentElement;
                const isDark = html.getAttribute('data-bs-theme') === 'dark';
                const next = isDark ? 'light' : 'dark';
                html.setAttribute('data-bs-theme', next);
                localStorage.setItem('theme', next);
            },

            showAdmin() {
                document.getElementById('home').classList.add('d-none');
                document.getElementById('shop').classList.add('d-none');
                document.getElementById('admin-dashboard').classList.remove('d-none');
                Admin.load();
            },

            modal(id) { new bootstrap.Modal(document.getElementById(id)).show(); },
            showToast(msg, bg = 'bg-success') {
                const el = document.getElementById('liveToast');
                el.className = `toast align-items-center text-white border-0 ${bg}`;
                document.getElementById('toast-text').innerText = msg;
                new bootstrap.Toast(el).show();
            }
        };

        window.onload = () => UI.init();

    </script>
