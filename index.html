<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Arthur Auto Pe√ßas - A evolu√ß√£o da sua experi√™ncia automotiva.">
    <title>Arthur Auto Pe√ßas | Ultimate Admin V3</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #475569;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-bs-theme="dark"] {
            --primary: #3b82f6;
            --glass: rgba(15, 23, 42, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --light: #1e293b;
            --text-body: #e2e8f0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--light);
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

        .navbar-blur {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border-bottom: var(--glass-border);
            padding: 1rem 0;
            transition: var(--transition);
        }

        .nav-link { font-weight: 600; letter-spacing: 0.5px; position: relative; }
        .nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 2px;
            background: var(--primary); transition: var(--transition); transform: translateX(-50%);
        }
        .nav-link:hover::after, .nav-link.active::after { width: 80%; }

        .card-hover {
            border: none; border-radius: 20px; background: white;
            box-shadow: var(--card-shadow); transition: var(--transition);
            overflow: hidden; position: relative;
        }
        [data-bs-theme="dark"] .card-hover { background: #1e293b; }
        .card-hover:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12); }

        .btn-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none; color: white; border-radius: 12px; padding: 12px 24px;
            font-weight: 700; transition: var(--transition);
        }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); }

        .hero-section {
            min-height: 80vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            position: relative; overflow: hidden; border-radius: 0 0 50px 50px;
            color: white; display: flex; align-items: center;
        }
        .hero-bg-accent {
            position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.2) 0%, transparent 70%);
            top: -100px; right: -100px; border-radius: 50%; animation: pulse 10s infinite;
        }

        .chat-widget {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 20px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 1000; display: flex; flex-direction: column; overflow: hidden;
            transform: translateY(120%); transition: var(--transition);
        }
        [data-bs-theme="dark"] .chat-widget { background: #1e293b; color: white; }
        .chat-open { transform: translateY(0); }
        .chat-header { background: var(--primary); color: white; padding: 15px; font-weight: bold; cursor: pointer; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f1f5f9; }
        [data-bs-theme="dark"] .chat-body { background: #0f172a; }
        .chat-input { padding: 15px; border-top: 1px solid rgba(0, 0, 0, 0.1); display: flex; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; max-width: 80%; font-size: 0.9rem; }
        .msg-ai { background: white; align-self: flex-start; border-bottom-left-radius: 2px; color: black; }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        .fade-in-up { animation: fadeInUp 0.8s ease-out; }
    </style>
</head>

<body class="fade-in-up">

    <script>
        const App = {
            config: {
                supabaseUrl: 'https://ydwxljgmzoqsemwemtml.supabase.co',
                supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlkd3hsamdtem9xc2Vtd2VtdG1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODM4ODEsImV4cCI6MjA4MDY1OTg4MX0.7elSMr11AHIhYayJgwqJQCpv0CdyiiM5XunW82Y-rAo',
                // --- CHAVE DO GOOGLE CLOUD CONSOLE ---
                geminiKey: 'AIzaSyAFpbvdVBQ1yI4cgfmF37QQM0YpEABuvQk', 
                // -------------------------------------
                whatsapp: '5585991815434',
                pixKey: '00.000.000/0001-00'
            },
            state: {
                user: JSON.parse(localStorage.getItem('user')) || null,
                cart: JSON.parse(localStorage.getItem('cart')) || [],
                activeModel: 'gemini-1.5-flash', // FIX: Definido manual para evitar erro 403
                loading: false
            }
        };
    </script>

    <nav class="navbar navbar-expand-lg navbar-blur fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img src="https://placehold.co/48x48?text=A" style="height: 48px;" alt="Logo">
                <div style="line-height:1.1">
                    <span class="fw-black d-block fs-5 text-primary">ARTHUR</span>
                    <small class="text-uppercase text-muted" style="font-size:0.65rem; letter-spacing: 2px;">Auto Pe√ßas</small>
                </div>
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
                <i class="bi bi-list fs-1 text-primary"></i>
            </button>

            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0 align-items-center">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="UI.showHome()">In√≠cio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#shop" onclick="UI.showHome()">Cat√°logo</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="Chatbot.toggle()">IA Mechanic</a></li>
                    <li class="nav-item d-none" id="nav-admin-link">
                        <a class="nav-link text-warning fw-bold" href="#" onclick="UI.showAdmin()"><i class="bi bi-shield-lock-fill"></i> Admin</a>
                    </li>
                </ul>

                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-secondary rounded-circle border-0" onclick="UI.toggleTheme()">
                        <i class="bi bi-moon-stars-fill"></i>
                    </button>

                    <button class="btn btn-outline-primary rounded-circle position-relative border-0" onclick="Cart.open()">
                        <i class="bi bi-file-text-fill fs-5"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-badge">0</span>
                    </button>

                    <div id="auth-container"></div>
                </div>
            </div>
        </div>
    </nav>

    <section id="home" class="hero-section">
        <div class="hero-bg-accent"></div>
        <div class="container position-relative z-index-1">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-5 mb-lg-0 animate__animated animate__fadeInLeft">
                    <span class="badge bg-white text-primary mb-3 px-3 py-2 rounded-pill fw-bold shadow-sm">
                        <i class="bi bi-shield-check me-1"></i> Seguran√ßa & Qualidade
                    </span>
                    <h1 class="display-3 fw-bolder mb-3">Sua Oficina <br><span class="text-primary">Inteligente</span></h1>
                    <p class="lead mb-4 text-white-50">Solicite or√ßamentos online. A IA analisa, n√≥s entregamos. Pre√ßos exclusivos para cadastrados.</p>
                    <div class="d-flex gap-3">
                        <a href="#shop" class="btn btn-gradient btn-lg">Ver Pe√ßas</a>
                        <button onclick="Chatbot.toggle()" class="btn btn-outline-light btn-lg border-2 fw-bold">Tirar D√∫vida</button>
                    </div>
                </div>
                <div class="col-lg-6 position-relative animate__animated animate__fadeInRight">
                    <img src="https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=800&q=80" class="img-fluid rounded-4 shadow-lg border border-3 border-dark" alt="Super Car">
                </div>
            </div>
        </div>
    </section>

    <section id="shop" class="py-5">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                <h2 class="fw-bold mb-0">Cat√°logo <span class="text-primary">de Pe√ßas</span></h2>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" placeholder="Buscar pe√ßa..." oninput="Shop.search(this.value)">
                </div>
            </div>
            <div class="alert alert-info border-0 shadow-sm">
                <i class="bi bi-info-circle-fill me-2"></i> <strong>Nota:</strong> Adicione itens ao or√ßamento para consultar valores atualizados.
            </div>
            <div id="product-grid" class="row g-4"></div>
        </div>
    </section>

    <section id="admin-dashboard" class="d-none py-5 bg-light" style="min-height: 100vh; padding-top: 100px;">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold"><i class="bi bi-speedometer2"></i> Painel do Administrador</h2>
                <button class="btn btn-outline-dark" onclick="UI.showHome()">Voltar ao Site</button>
            </div>

            <div class="row g-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="mb-0 fw-bold">Gerenciar Pedidos</h5>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" id="admin-search-id" placeholder="Buscar ID (ex: 12)" style="width: 150px;">
                                <button class="btn btn-sm btn-primary" onclick="Admin.load()"><i class="bi bi-search"></i></button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table align-middle mb-0 table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Total (Vis√≠vel)</th>
                                            <th>Status</th>
                                            <th>Pagamento</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-order-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Produtos (Tabela de Pre√ßos)</h5>
                            <button class="btn btn-sm btn-success" onclick="UI.modal('prod-modal')">+ Novo Produto</button>
                        </div>
                        <div class="card-body p-0">
                            <table class="table align-middle mb-0 table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Produto</th>
                                        <th>Categoria</th>
                                        <th>Pre√ßo (Admin)</th>
                                        <th>Estoque</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-prod-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="chatbot" class="chat-widget shadow-lg">
        <div class="chat-header d-flex justify-content-between align-items-center" onclick="Chatbot.toggle()">
            <span><i class="bi bi-robot me-2"></i>Mec√¢nico Virtual</span>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="chat-body" id="chat-messages">
            <div class="d-flex flex-column" id="chat-msg-container">
                <div class="msg msg-ai">Ol√°! Sou a IA da Arthur Auto Pe√ßas. Posso ajudar a montar seu or√ßamento t√©cnico.</div>
            </div>
        </div>
        <div class="chat-input bg-white">
            <input type="text" id="chat-txt" class="form-control border-0 bg-light" placeholder="Digite sua d√∫vida..." onkeypress="if(event.key==='Enter') Chatbot.send()">
            <button class="btn btn-primary rounded-circle" onclick="Chatbot.send()"><i class="bi bi-send-fill"></i></button>
        </div>
    </div>

    <div class="modal fade" id="auth-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 overflow-hidden">
                <div class="modal-body p-0 d-flex">
                    <div class="d-none d-md-block bg-primary text-white p-5 col-5 d-flex flex-column justify-content-center">
                        <h4>√Årea Segura</h4>
                        <p class="small opacity-75">Seus dados e or√ßamentos protegidos.</p>
                        <i class="bi bi-lock-fill fs-1 opacity-50 mt-3"></i>
                    </div>
                    <div class="p-4 col-12 col-md-7">
                        <div class="text-end"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab">
                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-login">Login</button></li>
                            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-register">Cadastro</button></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-login">
                                <form onsubmit="Auth.login(event)">
                                    <div class="form-floating mb-3"><input type="email" class="form-control" id="login-email" required><label>Email</label></div>
                                    <div class="form-floating mb-3"><input type="password" class="form-control" id="login-pass" required><label>Senha</label></div>
                                    <button class="btn btn-primary w-100 py-2 fw-bold">Acessar Or√ßamentos</button>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="tab-register">
                                <form onsubmit="Auth.register(event)">
                                    <input class="form-control mb-2" id="reg-name" placeholder="Nome Completo" required>
                                    <input class="form-control mb-2" id="reg-email" placeholder="Email" type="email" required>
                                    <input class="form-control mb-2" id="reg-cpf" placeholder="CPF" required>
                                    <input class="form-control mb-3" id="reg-pass" placeholder="Senha Forte" type="password" required>
                                    <div class="form-text mb-3 small">Sua senha ser√° criptografada antes do envio.</div>
                                    <button class="btn btn-success w-100 py-2 fw-bold">Criar Conta Segura</button>
                                </form>
                            </div>
                        </div>
                        <div id="auth-error" class="alert alert-danger mt-3 d-none small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cart-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold">Lista de Or√ßamento</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-secondary small"><i class="bi bi-eye-slash"></i> Os pre√ßos ser√£o revelados na etapa de aprova√ß√£o.</div>
                    <div id="cart-items-container"></div>
                    
                    <div id="ai-quote-box" class="p-3 border rounded bg-white mt-3 d-none font-monospace small"></div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-outline-primary" onclick="Cart.aiQuote()">üí° An√°lise T√©cnica IA</button>
                    <button class="btn btn-success fw-bold px-4" onclick="Cart.startCheckout()">Ver Pre√ßos & Finalizar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="checkout-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="fw-bold"><i class="bi bi-cash-coin"></i> Or√ßamento Final</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Resumo Financeiro</div>
                        <ul class="list-group list-group-flush" id="checkout-summary"></ul>
                        <div class="card-footer d-flex justify-content-between fw-bold fs-5">
                            <span>Total:</span>
                            <span class="text-success" id="checkout-total-display">R$ 0,00</span>
                        </div>
                    </div>

                    <p class="text-muted small">Escolha como deseja pagar este or√ßamento:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-success p-3 text-start" onclick="Cart.setPayment('pix')">
                            <div class="fw-bold"><i class="bi bi-qr-code"></i> PIX</div>
                        </button>
                        <button class="btn btn-outline-dark p-3 text-start" onclick="Cart.setPayment('loja')">
                            <div class="fw-bold"><i class="bi bi-shop"></i> Pagar na Loja</div>
                        </button>
                    </div>
                    <div id="pix-detalhes" class="d-none mt-3 p-3 bg-light border rounded text-center">
                        <small>Chave PIX (CNPJ):</small>
                        <h4 class="font-monospace">00.000.000/0001-00</h4>
                        <p class="small text-danger mb-0">Envie o comprovante no WhatsApp.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100 fw-bold" id="btn-submit-order" disabled onclick="Cart.submitOrder()">Confirmar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="admin-edit-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Editar Pedido #<span id="ae-id"></span></h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Itens do Pedido:</h6>
                    <ul class="list-group mb-3" id="ae-list"></ul>
                    <hr>
                    <div class="input-group">
                        <select class="form-select" id="ae-add-select"></select>
                        <button class="btn btn-success" onclick="Admin.addItem()">Adicionar</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="Admin.saveChanges()">Salvar & Aprovar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="prod-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="fw-bold">Gerenciar Produto</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-prod" onsubmit="Admin.saveProduct(event)">
                        <div class="mb-3">
                            <label class="form-label">Nome da Pe√ßa</label>
                            <input type="text" class="form-control" id="p-nome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o Breve</label>
                            <textarea class="form-control" id="p-desc" rows="2"></textarea>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-12"> <label class="form-label">Categoria</label>
                                <select class="form-select" id="p-cat">
                                    <option value="Motor">Motor</option>
                                    <option value="Freio">Freio</option>
                                    <option value="Suspens√£o">Suspens√£o</option>
                                    <option value="El√©trica">El√©trica</option>
                                    <option value="Acess√≥rios">Acess√≥rios</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">Pre√ßo (R$)</label>
                                <input type="number" step="0.01" class="form-control" id="p-preco" placeholder="0,00" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Estoque (Qtd)</label>
                                <input type="number" class="form-control" id="p-estoque" value="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL da Imagem</label>
                            <input type="text" class="form-control" id="p-img" placeholder="https://...">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary fw-bold">Salvar Produto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center text-white border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toast-text"></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /** SEGURAN√áA: CRIPTOGRAFIA (SHA-256) **/
        const Security = {
            async hashPassword(message) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        };

        /** SUPABASE & SERVICES **/
        const DB = {
            client: supabase.createClient(App.config.supabaseUrl, App.config.supabaseKey),
        };

        const Services = {
            async init() {
                // FIX: Removida a auto-detec√ß√£o que estava pegando modelo inexistente
                console.log("IA Iniciada com modelo padr√£o: ", App.state.activeModel);
            },

            async askGemini(prompt) {
                const key = App.config.geminiKey;
                // Usa o modelo fixo definido no App.state (gemini-1.5-flash)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${App.state.activeModel}:generateContent?key=${key}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.";
                } catch (e) {
                    console.error("Erro IA:", e);
                    return `‚ö†Ô∏è IA Indispon√≠vel (Erro: ${e.message}).`;
                }
            }
        };

        /** SHOP **/
        const Shop = {
            list: [],
            async init() {
                const { data } = await DB.client.from('produtos').select('*');
                this.list = data || [];
                this.render();
            },
            render(items = this.list) {
                const grid = document.getElementById('product-grid');
                if (!items.length) { grid.innerHTML = '<div class="col-12 text-center text-muted">Carregando...</div>'; return; }

                grid.innerHTML = items.map(p => `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="card card-hover h-100">
                            <div style="height:180px; overflow:hidden">
                                <img src="${p.imagem_url}" class="w-100 h-100 object-fit-cover" onerror="this.src='https://placehold.co/300?text=AutoPeca'">
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h6 class="fw-bold text-truncate">${p.nome}</h6>
                                <small class="text-muted d-block mb-2">${p.categoria || 'Geral'}</small>
                                <div class="mt-auto">
                                    <span class="badge bg-light text-secondary border mb-2 w-100 py-2">
                                        <i class="bi bi-lock-fill"></i> Pre√ßo sob consulta
                                    </span>
                                    <button class="btn btn-outline-primary btn-sm w-100 rounded-pill" onclick="Cart.add(${p.id})">
                                        + Or√ßamento
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },
            search(q) { this.render(this.list.filter(p => p.nome.toLowerCase().includes(q.toLowerCase()))); }
        };

        /** CART & CHECKOUT **/
        const Cart = {
            paymentMethod: null,
            add(id) {
                const p = Shop.list.find(x => x.id === id);
                if (p) { App.state.cart.push(p); this.save(); UI.toast("Adicionado ao or√ßamento!"); }
            },
            remove(i) { App.state.cart.splice(i, 1); this.save(); },
            save() { localStorage.setItem('cart', JSON.stringify(App.state.cart)); UI.updateCart(); },
            open() { UI.modal('cart-modal'); },

            async aiQuote() {
                const box = document.getElementById('ai-quote-box');
                box.classList.remove('d-none');
                box.innerHTML = "ü§ñ <em>A IA est√° analisando a compatibilidade...</em>";
                const prompt = `Atue como um mec√¢nico s√™nior. O cliente escolheu: ${App.state.cart.map(i => i.nome).join(', ')}. Fa√ßa um coment√°rio t√©cnico breve sobre a qualidade e import√¢ncia dessas pe√ßas.`;
                const txt = await Services.askGemini(prompt);
                box.innerHTML = txt.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            },

            startCheckout() {
                if (!App.state.user) return UI.toast("Fa√ßa login para ver pre√ßos.", "bg-warning");
                if (App.state.cart.length === 0) return;

                const list = document.getElementById('checkout-summary');
                let total = 0;
                list.innerHTML = App.state.cart.map(i => {
                    total += Number(i.preco);
                    return `<li class="list-group-item d-flex justify-content-between">
                        <span>${i.nome}</span>
                        <span>R$ ${i.preco}</span>
                    </li>`;
                }).join('');
                document.getElementById('checkout-total-display').innerText = `R$ ${total.toFixed(2)}`;

                UI.hideModal('cart-modal');
                UI.modal('checkout-modal');
                this.paymentMethod = null;
                document.getElementById('pix-detalhes').classList.add('d-none');
                document.getElementById('btn-submit-order').disabled = true;
            },

            setPayment(type) {
                this.paymentMethod = type;
                document.getElementById('pix-detalhes').classList.toggle('d-none', type !== 'pix');
                document.getElementById('btn-submit-order').disabled = false;
            },

            async submitOrder() {
                const total = App.state.cart.reduce((a, b) => a + Number(b.preco), 0);
                const order = {
                    user_id: App.state.user.id,
                    user_nome: App.state.user.nome,
                    items: App.state.cart,
                    total: total,
                    status: 'pendente',
                    pagamento_metodo: this.paymentMethod,
                    pagamento_status: 'aguardando'
                };

                const { data, error } = await DB.client.from('pedidos').insert([order]).select().single();

                if (error) {
                    console.error(error);
                    alert("Erro ao salvar pedido.");
                    return;
                }

                const orderId = data.id;
                UI.hideModal('checkout-modal');

                let msg = `Ol√°! Realizei o Or√ßamento #${orderId}.\n`;
                msg += `Itens: ${App.state.cart.length} unid.\nValor Total: R$ ${total.toFixed(2)}\n`;
                msg += `Pagamento: ${this.paymentMethod.toUpperCase()}\n`;
                
                window.open(`https://wa.me/${App.config.whatsapp}?text=${encodeURIComponent(msg)}`, '_blank');

                App.state.cart = [];
                this.save();
                UI.toast("Or√ßamento enviado!", "bg-success");
            }
        };

        /** ADMIN **/
        const Admin = {
            editId: null,
            tempItems: [],

            async load() {
                const searchId = document.getElementById('admin-search-id').value;
                let q = DB.client.from('pedidos').select('*').order('created_at', { ascending: false });
                if (searchId) q = q.eq('id', searchId);

                const { data } = await q;
                const body = document.getElementById('admin-order-list');
                
                if (data && data.length) {
                    body.innerHTML = data.map(o => `
                        <tr>
                            <td><strong>#${o.id}</strong></td>
                            <td>${o.user_nome}</td>
                            <td>R$ ${o.total}</td>
                            <td><span class="badge bg-${o.status === 'pendente' ? 'warning' : 'success'}">${o.status}</span></td>
                            <td>${o.pagamento_metodo}</td>
                            <td><button class="btn btn-sm btn-primary" onclick="Admin.openEdit(${o.id})">Ver</button></td>
                        </tr>
                    `).join('');
                } else {
                     body.innerHTML = '<tr><td colspan="6" class="text-center">Vazio.</td></tr>';
                }

                const pList = document.getElementById('admin-prod-list');
                pList.innerHTML = Shop.list.map(p => `
                    <tr>
                        <td>${p.nome}</td>
                        <td>${p.categoria || '-'}</td>
                        <td>R$ ${p.preco}</td>
                        <td>${p.estoque || 0}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="Admin.deleteProduct(${p.id})">Excluir</button></td>
                    </tr>`).join('');
            },

            async openEdit(id) {
                this.editId = id;
                const { data } = await DB.client.from('pedidos').select('*').eq('id', id).single();
                this.tempItems = data.items;
                this.renderEditList();
                const sel = document.getElementById('ae-add-select');
                sel.innerHTML = Shop.list.map(p => `<option value="${p.id}">${p.nome} (R$${p.preco})</option>`).join('');
                document.getElementById('ae-id').innerText = id;
                UI.modal('admin-edit-modal');
            },

            renderEditList() {
                const el = document.getElementById('ae-list');
                el.innerHTML = this.tempItems.map((item, idx) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${item.nome} <span class="badge bg-secondary">R$ ${item.preco}</span>
                        <button class="btn btn-sm btn-danger py-0" onclick="Admin.removeItem(${idx})">X</button>
                    </li>
                `).join('');
            },

            removeItem(idx) { this.tempItems.splice(idx, 1); this.renderEditList(); },
            addItem() {
                const id = document.getElementById('ae-add-select').value;
                const p = Shop.list.find(x => x.id == id);
                if (p) { this.tempItems.push(p); this.renderEditList(); }
            },
            async saveChanges() {
                const total = this.tempItems.reduce((a, b) => a + Number(b.preco), 0);
                await DB.client.from('pedidos').update({ items: this.tempItems, total: total, status: 'aprovado' }).eq('id', this.editId);
                UI.hideModal('admin-edit-modal');
                this.load();
                UI.toast("Atualizado!");
            },

            async saveProduct(e) {
                e.preventDefault();
                
                // Tratamento de Pre√ßo: Aceita v√≠rgula trocando por ponto
                let rawPrice = document.getElementById('p-preco').value;
                rawPrice = rawPrice.replace(',', '.'); 

                const prod = {
                    nome: document.getElementById('p-nome').value,
                    descricao: document.getElementById('p-desc').value,
                    categoria: document.getElementById('p-cat').value,
                    // preco_faixa REMOVIDO DAQUI
                    preco: rawPrice,
                    estoque: document.getElementById('p-estoque').value,
                    imagem_url: document.getElementById('p-img').value
                };

                const { error } = await DB.client.from('produtos').insert([prod]);
                if (error) {
                    alert('Erro ao salvar produto: ' + error.message);
                } else {
                    UI.hideModal('prod-modal');
                    document.getElementById('form-prod').reset();
                    UI.toast("Produto Salvo!");
                    Shop.init(); 
                    setTimeout(() => Admin.load(), 500);
                }
            },
            
            async deleteProduct(id) {
                if(!confirm('Tem certeza?')) return;
                await DB.client.from('produtos').delete().eq('id', id);
                Shop.init();
                setTimeout(() => Admin.load(), 500);
            }
        };

        /** AUTH **/
        const Auth = {
            async login(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim().toLowerCase();
                const pass = document.getElementById('login-pass').value.trim();
                const err = document.getElementById('auth-error');

                const hashedPassword = await Security.hashPassword(pass);
                const { data, error } = await DB.client.from('usuarios').select('*').ilike('email', email).maybeSingle();

                if (!data) {
                    err.classList.remove('d-none'); err.innerText = "Usu√°rio n√£o encontrado."; return;
                }
                
                if (data.senha !== hashedPassword && data.senha !== pass) {
                    err.classList.remove('d-none'); err.innerText = "Senha incorreta."; return;
                }

                this.setSession(data);
                UI.hideModal('auth-modal');
                UI.toast(`Bem-vindo, ${data.nome}!`);
            },

            async register(e) {
                e.preventDefault();
                const pass = document.getElementById('reg-pass').value;
                const hashedPassword = await Security.hashPassword(pass);

                const u = {
                    nome: document.getElementById('reg-name').value,
                    email: document.getElementById('reg-email').value.toLowerCase(),
                    cpf: document.getElementById('reg-cpf').value,
                    senha: hashedPassword, 
                    pontos: 0, is_admin: false
                };
                
                const { error } = await DB.client.from('usuarios').insert([u]);
                if (error) alert("Erro: " + error.message);
                else { alert("Conta Segura Criada! Fa√ßa login."); location.reload(); }
            },

            setSession(u) {
                App.state.user = u; localStorage.setItem('user', JSON.stringify(u)); UI.updateAuth();
            },
            logout() { localStorage.removeItem('user'); location.reload(); }
        };

        /** CHATBOT **/
        const Chatbot = {
            isOpen: false,
            toggle() { this.isOpen = !this.isOpen; document.getElementById('chatbot').classList.toggle('chat-open', this.isOpen); },
            async send() {
                const inp = document.getElementById('chat-txt');
                const txt = inp.value; if (!txt) return;

                this.msg(txt, 'user');
                inp.value = '';

                const tempId = 'temp-' + Date.now();
                this.msg('<span class="spinner-grow spinner-grow-sm"></span> Analisando...', 'ai', tempId);

                const res = await Services.askGemini(txt);
                const tempEl = document.getElementById(tempId);
                if (tempEl) tempEl.remove();

                const formatted = res.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
                this.msg(formatted, 'ai');
            },
            msg(txt, role, id = '') {
                const d = document.createElement('div');
                if (id) d.id = id;
                d.className = `msg msg-${role} animate__animated animate__fadeIn`;
                d.innerHTML = txt;
                const db = document.getElementById('chat-msg-container');
                db.appendChild(d);
                const widgetBody = document.getElementById('chat-messages');
                widgetBody.scrollTop = widgetBody.scrollHeight;
            }
        };

        /** UI INIT **/
        const UI = {
            init() {
                Shop.init();
                this.updateAuth();
                this.updateCart();
                if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-bs-theme', 'dark');
                Services.init();
            },
            updateAuth() {
                const u = App.state.user;
                const el = document.getElementById('auth-container');
                if (u) {
                    if (u.is_admin) document.getElementById('nav-admin-link').classList.remove('d-none');
                    el.innerHTML = `<button class="btn btn-sm btn-light border" onclick="Auth.logout()">Sair</button>`;
                } else {
                    el.innerHTML = `<button class="btn btn-gradient btn-sm" onclick="UI.modal('auth-modal')">Entrar</button>`;
                }
            },
            updateCart() {
                document.getElementById('cart-badge').innerText = App.state.cart.length;
                const cList = document.getElementById('cart-items-container');
                cList.innerHTML = App.state.cart.map((i, idx) => `
                    <div class="d-flex justify-content-between border-bottom py-2">
                        <div><small class="fw-bold">${i.nome}</small><br><span class="badge bg-light text-muted border">Pre√ßo oculto</span></div>
                        <button class="btn btn-link text-danger p-0 align-self-center" onclick="Cart.remove(${idx})"><i class="bi bi-trash"></i></button>
                    </div>`).join('') || '<p class="text-center text-muted small">Nenhuma pe√ßa no or√ßamento.</p>';
            },
            showHome() {
                document.getElementById('home').classList.remove('d-none');
                document.getElementById('shop').classList.remove('d-none');
                document.getElementById('admin-dashboard').classList.add('d-none');
            },
            showAdmin() {
                document.getElementById('home').classList.add('d-none');
                document.getElementById('shop').classList.add('d-none');
                document.getElementById('admin-dashboard').classList.remove('d-none');
                Admin.load();
            },
            modal(id) {
                const el = document.getElementById(id);
                let myModal = bootstrap.Modal.getInstance(el);
                if (!myModal) myModal = new bootstrap.Modal(el);
                myModal.show();
            },
            hideModal(id) {
                const el = document.getElementById(id);
                const myModal = bootstrap.Modal.getInstance(el);
                if (myModal) myModal.hide();
            },
            toast(msg, bg = 'bg-primary') {
                const el = document.getElementById('liveToast');
                el.className = `toast align-items-center text-white border-0 ${bg}`;
                document.getElementById('toast-text').innerText = msg;
                new bootstrap.Toast(el).show();
            },
            toggleTheme() {
                const r = document.documentElement;
                const n = r.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                r.setAttribute('data-bs-theme', n); localStorage.setItem('theme', n);
            }
        };

        window.onload = () => UI.init();

    </script>
</body>

</html>
